<chapter>
<title>Manteniendo La Hora</title>

<blockquote><para><quote>"Time is an illusion. Lunchtime double so."</quote> (Douglas Adams.)</para></blockquote>

<para>
En este capítulo se explica como un sistema Linux mantiene la fecha y hora,
y lo que debe conocer para evitar problemas.
Usualmente no es necesario realizar
ninguna actividad, pero es bueno entender su funcionamiento.
</para>

<sect1>
<title>Zonas horarias</title>
<para>
Las mediciones horarias están basadas en su mayoría a fenómenos naturales regulares,
como por ejemplo, los periodos alternados de luz y oscuridad
causados por la rotación del planeta. El tiempo total tomado por dos períodos
sucesivos es constante, pero la duración del período de luz varía
con respecto al de oscuridad. Una constante simple es la luz del mediodía.
</para>

<para>
El mediodía es el momento del día en el cual el Sol se encuentra en la posición más alta. 
Debido a la rotación de la Tierra,
		<footnote><para>According to
		recent research.</para></footnote>

 el momento del mediodía sucede en diferentes 
momentos en diferentes lugares. Esto nos conduce al concepto de <glossterm>hora local</glossterm>.
La hora se mide en muchas unidades, y con frecuencia, estas
mediciones están relacionadas a fenómenos naturales como la luz del mediodía.
En caso de que permanezca siempre en el mismo lugar, las diferencias entre los
horarios locales no tienen mucha importancia.
</para>

<para>
En cuanto necesite comunicarse con lugares distantes, notará la necesidad de una
hora en común. Hoy en día, la mayoría de los lugares en el mundo deben
comunicarse con otros, por lo que se definió un estándar mundial de medición
horaria. Este estándar se llama <glossterm>hora universal</glossterm> (UT o UTC, formalmente
conocido como Greenwich Mean Time o GMT, debido a que se utiliza como hora
local en Greenwich, Inglaterra). Cuando personas con diferentes horas locales
necesitan comunicarse, pueden expresar el tiempo en hora universal,
para que no exista confusión acerca de cuando deben suceder las cosas.
</para>

<para>
Cada hora local es llamada zona horaria (time zone), y existen 24 zonas horarias
en el planeta. Aunque geográficamente es posible pensar que todos los lugares
en donde el mediodía suceda en el mismo momento tienen la misma zona horaria,
políticamente no siempre esto es posible. Por diversas razones, varios países
adoptan el "horario de verano" (<glossterm>daylight savings time</glossterm>) para atender las demandas
económicas. Los países que adoptan el "horario de verano" cambian la hora
de sus relojes en verano (en gral. se retrasan los relojes una hora) para
tener más luz natural mientras trabajan (durante la tarde), y vuelven a adelantar
la hora de sus relojes en otoño u invierno. Otros países no adoptan estos procedimientos.
Los países que utilizan horarios de verano no tienen un acuerdo común de cuando deben
modificarse los relojes, y cambian, además, las reglas año tras año. Por lo que las
conversiones de zonas horarios son definitivamente no-triviales.
</para>

<para>
Las zonas horarias son denominadas de mejor manera a través de su ubicación o por
la diferencia entre la hora universal y la hora local. En los Estados Unidos y
en algunos otros países, las zonas horarias locales tienen un nombre y una abreviatura
de tres letras. Las abreviaturas no son únicas, por lo que no deberían
ser utilizadas sin que aparezca también el nombre del país. Es mejor referirse a la
la hora local en Helsinki, que referirse a la hora del Este de Europa, debido a que
no todos los países del Este de Europa adoptan las mismas reglas.
</para>

<para>
Linux tiene un paquete de zonas horarias que reconoce todas las zonas horarias existentes,
y puede ser fácilmente actualizado cuando las reglas cambian. Todo lo que un administrador de 
sistemas necesita hacer es seleccionar la zona horaria apropiada. Cada usuario también
puede establecer su propia zona horaria; por lo que facilita el trabajo de mucha gente,
debido a que muchas personas trabajan en diferentes países a través de Internet.
Cuando las reglas del "horario de verano" cambia en su zona horaria local, asegúrese
de actualizar al menos la zona horaria del sistema. Además de configurar la zona horaria
del sistema y de actualizar los archivos de datos de zonas horarias de vez en cuando, 
no hay mucho de que preocuparse con respecto al tiempo.
</para>

</sect1>

<sect1>
<title>Los relojes de software y hardware</title>

<para>
Una computadora personal tiene un reloj de hardware alimentado por una batería.
Esa batería asegura que el reloj continúe trabajando aún cuando la computadora se encuentre sin
suministro eléctrico. El reloj de hardware puede ser modificado (o definido)
desde la pantalla de configuración de la BIOS o desde cualquier sistema operativo.

</para>

<para>
El kernel Linux mantiene la fecha y hora de manera independiente al reloj de hardware.
Durante el inicio de un sistema Linux, el kernel configura su propio reloj de software accediendo
a la fecha y hora mantenida por el reloj de hardware.
Luego, ambos relojes trabajan independientemente.
Linux mantiene su propio reloj debido a que leer el reloj de hardware constantemente es lento y complicado.
</para>

<para>
El reloj del kernel siempre muestra la hora universal, por lo que
no necesita conocer como utilizar usos horarios. La simplicidad de este
modo de trabajar proporciona alta confiabilidad y facilita actualizar 
la información de la zona horaria. Cada proceso realiza las conversiones de zona horaria 
de manera independiente (utilizando herramientas estándar que son parte del paquete de zona horaria).
</para>

<para>
El reloj de hardware puede estar en formato de hora local u hora universal.
Usualmente es mejor que el reloj de hardware mantenga la hora universal,
porque de esta manera no será necesario modificar la hora del reloj cuando el "horario de verano"
(daylight savings time) empiece o finalice (UTC no tiene DST). Desafortunadamente, algunos sistemas operativos de PC
(incluyendo a MS-DOS, Windows y OS/2) asumen que el reloj de hardware muestra la hora local.
Linux puede manejar cualquiera de los dos formatos, pero si el reloj de hardware muestra la hora local,
entonces debe modificarlo cada vez que el "horario de verano" empiece o finalice.
</para>

</sect1>


<sect1>
<title>Configurar y visualizar la hora</title>

<para>
En Linux, la zona horaria del sistema es determinada por <filename>/etc/localtime</filename> (algunas veces
es un enlace simbólico). Si es un enlace, entonces apunta a un archivo de datos de zona horaria
que describe la zona horaria local. Los archivos de datos de zonas horarias están ubicados en
<filename>/usr/lib/zoneinfo</filename> o <filename>/usr/share/zoneinfo</filename>. (Otras distribuciones de Linux pueden llegar
a determinar la zona horaria del sistema de manera diferente.)
</para>

<para>
Por ejemplo, en un sistema SuSE ubicado en New Jersey, <filename>/etc/localtime</filename> apuntaría a <filename>/usr/share/zoneinfo/US/Eastern</filename>.
</para>

<para>
Si no encuentra el directorio <filename>zoneinfo</filename> en <filename>/usr/lib</filename> o en <filename>/usr/share</filename>, intente encontrarlo ejecutando
<command>find /usr -type d -name zoneinfo</command>, o consulte la documentación de su distribución Linux.
</para>

<para>
¿Qué sucede cuando existen usuarios utilizando el mismo sistema pero se encuentran ubicados en
zonas horarias diferentes?
Un usuario puede cambiar su zona horaria privada definiendo la variable del ambiente TZ.
Si TZ no se encuentra definida, entonces la zona horaria del sistema es la utilizada.
La sintaxis de la variable TZ se encuentra descripta en la página de manual de <command>tzset</command>.
</para>


<para>
El comando <command>date</command> muestra la hora y fecha actuales. Por ejemplo:

		<footnote><para>Tenga cuidado con el comando <command>time</command>,
		ya que no muestra la fecha y hora del sistema.</para></footnote>

	For example:

<screen>
<prompt>$</prompt> <userinput>date</userinput>
<computeroutput>Sun Jul 14 21:53:41 EET DST 1996</computeroutput>
<prompt>$</prompt>
</screen>

Domingo, 14 de julio de 1996, alrededor de las 10 menos 10 de la noche, en la zona horaria llamada <quote>"EET DST"</quote>
(la cual puede ser el "horario de verano" del Día del Este de Europa).
<command>date</command> puede también mostrar la hora en forma universal:


<screen>
<prompt>$</prompt> <userinput>date -u</userinput>
<computeroutput>Sun Jul 14 18:53:42 UTC 1996</computeroutput>
<prompt>$</prompt>
</screen>

	<command>date</command> también se utiliza para establecer la hora del reloj del kernel:
	

<screen>
<prompt>#</prompt> <userinput>date 07142157</userinput>
<computeroutput>Sun Jul 14 21:57:00 EET DST 1996</computeroutput>
<prompt>#</prompt> <userinput>date</userinput>
<computeroutput>Sun Jul 14 21:57:02 EET DST 1996</computeroutput>
<prompt>#</prompt>
</screen>

Lea la página de manual de <command>date</command> si desea conocer mayores detalles; ya que la sintaxis es un poco complicada.
Solo el usuario root puede modificar la fecha y/u hora. Aunque cada usuario puede definir su propia zona horaria,
el reloj es el mismo para todos.
</para>

<para>
<command>Date</command> solo muestra o modifica el reloj de software. El comando <command>clock</command> sincroniza los relojes de hardware y software.
Cuando el sistema inicia, el comando clock es utilizado para leer el reloj de hardware y actualizar
el reloj de software. Si necesita modificar ambos relojes, primero debe modificar el reloj de software con <command>date</command>,
y luego sincronizar la hora del reloj por hardware con el comando <command>clock -w</command>.
</para>

<para>
La opción <option>-u</option> en el comando <command>lock</command> le indica a clock que la fecha y hora (mostrada o definida)
se encuentra en formato de hora universal. <emphasis>Debe</emphasis> utilizar la opción <option>-u</option> correctamente, en
caso contrario, la computadora puede estar confundida sobre cual es la fecha y hora correcta.
</para>

<para>
Los relojes deben modificarse con cuidado y precisión.
Muchas partes de un sistema UNIX requieren que los relojes trabajen correctamente.
Por ejemplo, el demonio <command>cron</command> ejecuta comandos periódicamente. Si cambia el reloj, el sistema puede
estar confundido en cuanto a la necesidad o no de ejecutar determinado comando.
Hubo una vez, en un sistema UNIX antiguo, en donde alguien adelantó el reloj 20 años en el futuro, y
entonces <command>cron</command> quiso ejecutar
los comandos periódicos de veinte años, todos de una sola vez.
Las versiones actuales de <command>cron</command> no tienen este problema, pero aún así debe ser cuidadoso con estos
detalles (pueden existir otros programas actuales que trabajen similarmente mal como "ese" viejo cron).
Grandes saltos en el tiempo (hacia el futuro o el pasado) son mas peligrosos que pequeñas diferencias.
</para>

</sect1>

<sect1>

<title>Cuando el reloj es erróneo</title>

<para>
El reloj por software de un sistema Linux no siempre es preciso. Para mantener este reloj
Linux utiliza una <glossterm>interrupción periódica</glossterm> generada por el hardware, llamada "timer interrupt".
En caso de que existan muchos procesos siendo ejecutados (con respecto a los recursos disponibles)
el sistema podría demorar un poco al momento de intentar servir la interrupción, por lo que 
el reloj de software puede estar ligeramente atrasado. El reloj por hardware trabaja
independientemente del sistema operativo, así que usualmente es mas preciso. 
Si re-inicia de manera frecuente la computadora (como es el caso para la mayoría de los
sistemas que no son servidores) el reloj debe encontrarse prácticamente correcto.
</para>

<para>
Si es necesario modificar el reloj de hardware, la manera mas simple es reiniciar el sistema,
ingresar a la pantalla de configuración de la BIOS y realizar el cambio de fecha y hora desde
ahí. Esta manera evita todos los problemas que podrían suceder si se modifica el reloj desde 
el sistema. Si la modificación desde la configuración de la BIOS no se puede realizar, modifique
el reloj utilizando <command>date</command> y <command>clock</command> (en ese orden), pero esté preparado para reiniciar Linux, si
alguna parte del sistema comienza a actuar de manera extraña, mal y/o divertida. :)
</para>

<para>
Otro método posible para sincronizar el reloj de software es utilizar <command>hwclock -w</command> o <command>hwclock --systohc</command>.
Ambos comandos obtienen la fecha y hora desde el reloj de hardware y modifican el reloj de software.
Si en cambio desea sincronizar de manera inversa (modificar el reloj de hardware con la fecha y
hora del reloj de software) entonces puede utilizar el comando <command>hwclock -s</command> o el comando
<command>hwclock --hctosys</command>. Si desea conocer mayores detalles de este comando lea su página de manual
ejecutando man <command>hwclock</command>.
</para>


</sect1>

<sect1>

<title>NTP - Protocolo de reloj en red</title>

<para>
Un ordenador conectado en red (incluso únicamente con un módem) puede 
comprobar su propio reloj de forma automática comparándolo con la hora
de otro ordenador que se sabe almacena la hora de forma precisa. El 
protocolo de reloj en red (o NTP) hace esto exactamente. Es un método para 
verificar y corregir la hora de su ordenador al sincronizarse con otro 
sistema. Con NTP su sistema puede mantenerse a milisegundos de la Hora 
Universal Coordinada. 
	<footnote><para>Visite el sitio web <ulink url="http://www.time.gov/about.html/">
		http://www.time.gov/about.html</ulink> si desea obtener mayor información.</para>
		</footnote>
	</para>

<para>
Para la mayoría de usuarios ocasionales de Linux, esto puede resultar
simplemente un lujo. En mi casa todos los relojes se ajustan en base a 
la hora que mi sistema Linux dice que es. Para grandes organizaciones 
este "lujo" puede convertirse en fundamental. Ser capaz de buscar sucesos 
en los archivos de diario basándose en la hora puede hacer la vida 
bastante más sencilla y puede eliminar mucho "trabajo de adivinación" 
durante la depuración.
</para>

<para>
Otro ejemplo de cuan importante puede ser NTP es con SAN. Algunos SAN
necesitan NTP para configurarse y funcionar adecuadamente para permitir
la correcta sincronización durante el uso del sistema de ficheros, y un
control adecuado de las marcas de tiempo. Algunos SAN (y algunas
aplicaciones) pueden confundirse cuando tratan con archivos que tienen marcas
de tiempo que están en el futuro.
</para>

<para>
La mayoría de las distribuciones Linux vienen con un paquete NTP de
algún tipo, ya sea un paquete .deb o .rpm. Puede utilizarlo para instalar
NTP, o puede bajarse el código fuente de
<ulink url="http://www.ntp.org/downloads.html">
http://www.ntp.org/downloads.html</ulink> y compilarlo usted mismo. En
cualquier caso, la configuración básica es la misma.
</para>

</sect1>


<sect1>
<title>Configuración básica de NTP</title>

<para>
El programa NTP se configura utilizando el archivo <filename>/etc/ntp.conf</filename> o
<filename>/etc/xntp.conf</filename> dependiendo de qué distribución Linux tenga. No entraré
ahora en demasiados detalles sobre cómo configurar NTP. En su lugar cubriré
sólo lo básico.
</para>

<para>
Un ejemplo de archivo ntp.conf debería parecer:


<screen>
<computeroutput># --- GENERAL CONFIGURATION ---
server  aaa.bbb.ccc.ddd
server  127.127.1.0
fudge   127.127.1.0 stratum 10

# Drift file.

driftfile /etc/ntp/drift
</computeroutput>
</screen>
	</para>

	<para>El archivo ntp.config más básico simplemente listará 2 servidores, uno
con el que le gustaría sincronizarse, y una dirección pseudo-IP para él 
mismo (en este caso 127.127.1.0). La pseudo-IP se utiliza en el caso de
errores en la red o si cae el servidor NTP remoto. NTP sincronizará
consigo mismo hasta que pueda empezar a sincronizar de nuevo con el 
servidor remoto. Se recomienda que se pongan al menos 2 servidores remotos
con los que pueda sincronizarse. Uno actuará como servidor primario y el 
otro como copia de respaldo.
</para>

<para>
También debe ponerse una ubicación para el archivo de fluctuación. De 
vez en cuando NTP <quote>aprenderá</quote> el error que se comete en el reloj de
sistema y automáticamente se ajustará.
</para>

<para>
La opción de restricción puede usarse para otorgar un mejor control y 
seguridad además de la que proporciona NTP, y quién puede efectuarla.
Por ejemplo:
<screen>
<computeroutput># Prohibit general access to this service.
restrict default ignore

# Permit systems on this network to synchronize with this
# time service. But not modify our time.
restrict aaa.bbb.ccc.ddd nomodify

# Allow the following unrestricted access to ntpd

restrict aaa.bbb.ccc.ddd
restrict 127.0.0.1
</computeroutput>
</screen>

Está avisado: debe esperar hasta que tenga NTP trabajando adecuadamente 
antes de añadir la opción de restricción. Puede accidentalmente 
restringirse usted mismo de sincronizarse y perder tiempo buscando el por qué.
</para>

<para>
NTP corrige el sistema lentamente. ¡Sea paciente! Una simple prueba es
cambiar el reloj de sistema en 10 minutos antes de irse a la cama y
comprobarlo cuando se levante. La hora deberá ser la correcta.
</para>



</sect1>

<sect1>
<title>La herramienta NTP</title>

<para>
Hay innumerables utilidades disponibles para comprobar si NTP está 
haciendo su trabajo. El comando <command>ntpq -p</command> mostrará el estado de la hora
actual de su sistema.

<screen>
<prompt>#</prompt> <userinput>ntpq -p</userinput>
<computeroutput>     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*cudns.cit.corne ntp0.usno.navy.  2 u  832 1024  377   43.208    0.361   2.646
 LOCAL(0)        LOCAL(0)        10 l   13   64  377    0.000    0.000   0.008
</computeroutput>
</screen>
	</para>

<para>
<command>ntpdc -c</command> loopinfo mostrará cómo de desviado está el reloj del sistema
en segundos, basándose en la última vez que se contactó con el servidor 
remoto.

<screen>

<prompt>#</prompt> <userinput>ntpdc -c loopinfo</userinput>
<computeroutput>offset:               -0.004479 s
frequency:            133.625 ppm
poll adjust:          30
watchdog timer:       404 s
</computeroutput>
</screen>
	</para>

	<para><command>ntpdc -c kerninfo</command>  mostrará la corrección actual acumulada.

<screen>
<prompt>#</prompt> <userinput>ntpdc -c kerninfo</userinput>
<computeroutput>pll offset:           -0.003917 s
pll frequency:        133.625 ppm
maximum error:        0.391414 s
estimated error:      0.003676 s
status:               0001  pll
pll time constant:    6
precision:            1e-06 s
frequency tolerance:  512 ppm
pps frequency:        0.000 ppm
pps stability:        512.000 ppm
pps jitter:           0.0002 s
calibration interval: 4 s
calibration cycles:   0
jitter exceeded:      0
stability exceeded:   0
calibration errors:   0
</computeroutput>
</screen>
	</para>

	
	
	<para>
Una versión ligeramente distinta de <command>ntpdc -c kerninfo</command> es <command>ntptime</command>

<screen>
<prompt>#</prompt> <userinput>ntptime</userinput>
<computeroutput>ntp_gettime() returns code 0 (OK)
  time c35e2cc7.879ba000  Thu, Nov 13 2003 11:16:07.529, (.529718),
  maximum error 425206 us, estimated error 3676 us
ntp_adjtime() returns code 0 (OK)
  modes 0x0 (),
  offset -3854.000 us, frequency 133.625 ppm, interval 4 s,
  maximum error 425206 us, estimated error 3676 us,
  status 0x1 (PLL),
  time constant 6, precision 1.000 us, tolerance 512 ppm,
  pps frequency 0.000 ppm, stability 512.000 ppm, jitter 200.000 us,
  intervals 0, jitter exceeded 0, stability exceeded 0, errors 0.
</computeroutput>
</screen>
	</para>
	
	
<para>
Existe todavía otra manera de ver cómo de bien está trabajando NTP con 
el comando <command>ntpdate -d</command>. Éste contactará con un servidor NTP y
determinará la diferencia de tiempos pero no modificará el reloj de su sistema.


<screen>
<prompt>#</prompt> <userinput>ntpdate -d 132.236.56.250</userinput>
<computeroutput>13 Nov 14:43:17 ntpdate[29631]: ntpdate 4.1.1c-rc1@1.836 Thu Feb 13 12:17:20 EST 2003 (1)
transmit(132.236.56.250)
receive(132.236.56.250)
transmit(132.236.56.250)
receive(132.236.56.250)
transmit(132.236.56.250)
receive(132.236.56.250)
transmit(132.236.56.250)
receive(132.236.56.250)
transmit(132.236.56.250)
server 132.236.56.250, port 123
stratum 2, precision -17, leap 00, trust 000
refid [192.5.41.209], delay 0.06372, dispersion 0.00044
transmitted 4, in filter 4
reference time:    c35e5998.4a46cfc8  Thu, Nov 13 2003 14:27:20.290
originate timestamp: c35e5d55.d69a6f82  Thu, Nov 13 2003 14:43:17.838
transmit timestamp:  c35e5d55.d16fc9bc  Thu, Nov 13 2003 14:43:17.818
filter delay:  0.06522  0.06372  0.06442  0.06442
         0.00000  0.00000  0.00000  0.00000
filter offset: 0.000036 0.001020 0.000527 0.000684
         0.000000 0.000000 0.000000 0.000000
delay 0.06372, dispersion 0.00044
offset 0.001020

13 Nov 14:43:17 ntpdate[29631]: adjust time server 132.236.56.250 offset 0.001020 sec
</computeroutput>
</screen>
	</para>

	<para>
Si quiere ver al sistema sincronizarse en tiempo real puede utilizar 
<command>ntptrace</command>.

<screen>
<prompt>#</prompt> <userinput>ntptrace 132.236.56.250</userinput>
<computeroutput>cudns.cit.cornell.edu: stratum 2, offset -0.003278, synch distance 0.02779
dtc-truetime.ntp.aol.com: stratum 1, offset -0.014363, synch distance 0.00000, refid 'ACTS'</computeroutput>
</screen>
	</para>

	
	<para>
Si necesita sincronizar su sistema inmediatamente puede utilizar
<command>ntpdate remote-servername</command> para forzar una sincronización. ¡Sin esperas!

<screen>
<prompt>#</prompt> <userinput>ntpdate 132.236.56.250</userinput>
13 Nov 14:56:28 ntpdate[29676]: adjust time server 132.236.56.250 offset -0.003151 sec
<computeroutput></computeroutput>
</screen>
</para>

</sect1>


<sect1>
<title>Algunos servidores NTP conocidos</title>

<para>
Una lista de servidores públicos puede obtenerse de:
<ulink url="http://www.eecis.udel.edu/~mills/ntp/servers.html/">
	http://www.eecis.udel.edu/~mills/ntp/servers.html</ulink>. Por favor lea la
información de utilización de la página antes de utilizar un servidor. No 
todos los servidores tienen el suficiente ancho de banda para permitir 
un gran número de sistemas sincronizándose con ellos. Así que es buena 
idea contactar con el administrador de sistemas antes de utilizar su 
servicio NTP.
</para>
</sect1>

<sect1>

<title>Enlaces NTP</title>

<para>
Información más detallada sobre NTP puede obtenerse de la página
original NTP: <ulink url="http://www.ntp.org/">http://www.ntp.org</ulink>, o de
<ulink url="http://www.ntp.org/ntpfaq/NTP-a-faq.htm">
	http://www.ntp.org/ntpfaq/NTP-a-faq.htm</ulink>
</para>
</sect1>
</chapter>

